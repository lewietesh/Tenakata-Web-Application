<?php
// Database connection
include 'db.php';

// Get POST data
$firstName = $_POST['firstName'];
$lastName = $_POST['lastName'];
$email = $_POST['email'];
$gender = $_POST['gender'];
$age = $_POST['age'];
$maritalStatus = $_POST['maritalStatus'];
$height = $_POST['height'];
$country = $_POST['country'];
$iq = $_POST['iq'];
$gpsLocation = $_POST['gpsLocation'];
$photo = $_FILES['photo'];

// Handle photo upload
$photoUrl = uploadPhoto($photo);

// Calculate admissibility score
$score = calculateAdmissibility($age, $gender, $iq);

// Save candidate data to database
$sql = "INSERT INTO candidates (first_name, last_name, email, gender, age, marital_status, height, country, photo_url, iq_test_result, gps_location, admissibility_score)
        VALUES ('$firstName', '$lastName', '$email', '$gender', '$age', '$maritalStatus', '$height', '$country', '$photoUrl', '$iq', '$gpsLocation', '$score')";

if ($conn->query($sql) === TRUE) {
    // Generate PDF
    $pdfUrl = generatePdf();

    // Fetch all candidates for ranking
    $scoreCardHtml = generateScoreCardHtml();

    echo json_encode(['success' => true, 'scoreCardHtml' => $scoreCardHtml, 'pdfUrl' => $pdfUrl]);
} else {
    echo json_encode(['success' => false, 'message' => 'Error: ' . $sql . '<br>' . $conn->error]);
}



// Function to handle photo upload
function uploadPhoto($photo) {
    // Upload to S3 or similar cloud service
    // Here, we're just saving to a local directory for simplicity
    $target_dir = "uploads/";
    $target_file = $target_dir . basename($photo["name"]);
    move_uploaded_file($photo["tmp_name"], $target_file);

    // Return the URL of the uploaded file
    return $target_file;
}

// Function to calculate admissibility score
function calculateAdmissibility($age, $gender, $iq) {
    $score = 0;
    if ($gender == 'female') $score += 56.5;
    if ($age > 43) $score += 20;
    if ($age < 26) $score -= 10;
    if ($iq > 100) $score += 50;
    return $score;
}

// Function to generate PDF
function generatePdf() {
    // Use a PDF library like TCPDF to generate the PDF
    // Here, we're just returning a placeholder URL for simplicity
    return 'https://example.com/candidates.pdf';
}

// Function to generate score card HTML
function generateScoreCardHtml() {
    // Fetch all candidates and their scores from the database
    // Here, we're just returning placeholder HTML for simplicity
    return '<p>Score Card Content</p>';
}
?>
